<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Iframe Demo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { margin: 0; display: flex; flex-direction: column; height: 100vh; }
    #menu { flex-wrap: wrap; }
    #tabs { flex-shrink: 0; }
    #iframe-container { flex: 1; width: 100%; }
    iframe { width: 100%; height: 100%; border: none; display: none; }
    iframe.active { display: block; }
    #tabs .nav-link { position: relative; }
    #tabs .close { position: absolute; right: 4px; top: 4px; font-size: 12px; cursor: pointer; }
  </style>
</head>
<body class="m-0">
  <nav id="menu" class="navbar navbar-dark bg-dark p-2">
    <button class="btn btn-secondary me-2" data-url="https://example.com">Example</button>
    <button class="btn btn-secondary me-2" data-url="https://www.wikipedia.org">Wikipedia</button>
    <button class="btn btn-secondary me-2" data-url="https://www.bing.com">Bing</button>
    <button class="btn btn-secondary me-2" data-url="hello.html">Hello Page</button>
    <button class="btn btn-secondary" data-url="search.html">Search Demo</button>
  </nav>
  <ul id="tabs" class="nav nav-tabs"></ul>
  <div id="iframe-container"></div>
  <script>
    const menu = document.getElementById('menu');
    const tabsDiv = document.getElementById('tabs');
    const iframeContainer = document.getElementById('iframe-container');

    menu.addEventListener('click', e => {
      if (e.target.tagName !== 'BUTTON') return;
      const url = e.target.dataset.url;
      openTab(url, e.target.textContent);
    });

    function openTab(url, title) {
      const existing = document.querySelector(`#tabs .nav-link[data-url="${url}"]`);
      if (existing) {
        switchTab(url);
        return;
      }
      const li = document.createElement('li');
      li.className = 'nav-item';
      const link = document.createElement('a');
      link.className = 'nav-link';
      link.dataset.url = url;
      link.textContent = title;
      const close = document.createElement('span');
      close.textContent = '\u00d7';
      close.className = 'close';
      link.appendChild(close);
      li.appendChild(link);
      tabsDiv.appendChild(li);

      const iframe = document.createElement('iframe');
      iframe.src = url;
      iframe.dataset.url = url;
      iframe.addEventListener('load', () => {
        try {
          const path = iframe.contentWindow.location.pathname.split('/').pop();
          const fullUrl = path + iframe.contentWindow.location.search;
          iframe.dataset.url = fullUrl;
          link.dataset.url = fullUrl;
        } catch (e) {
          // Ignore cross-origin frames
        }
      });
      iframeContainer.appendChild(iframe);

      switchTab(url);
    }

    function switchTab(url) {
      document.querySelectorAll('#tabs .nav-link').forEach(t => {
        t.classList.toggle('active', t.dataset.url === url);
      });
      document.querySelectorAll('#iframe-container iframe').forEach(f => {
        f.classList.toggle('active', f.dataset.url === url);
      });
    }

    tabsDiv.addEventListener('click', e => {
      const link = e.target.closest('.nav-link');
      if (!link) return;
      const url = link.dataset.url;
      if (e.target.classList.contains('close')) {
        closeTab(url);
      } else {
        switchTab(url);
      }
    });

    function closeTab(url) {
      const link = document.querySelector(`#tabs .nav-link[data-url="${url}"]`);
      const iframe = document.querySelector(`#iframe-container iframe[data-url="${url}"]`);
      if (link) link.parentElement.remove();
      if (iframe) iframe.remove();
      const lastLink = tabsDiv.querySelector('.nav-link:last-of-type');
      if (lastLink) switchTab(lastLink.dataset.url);
    }

    // Expose functions for child iframes
    window.openTab = openTab;
    window.closeTab = closeTab;

    // Forward messages between iframes
    window.addEventListener('message', e => {
      if (e.data && e.data.type === 'saveRecord') {
        const searchFrame = document.querySelector('#iframe-container iframe[data-url^="search-results.html"]');
        if (searchFrame && searchFrame.contentWindow) {
          searchFrame.contentWindow.postMessage(e.data, '*');
        }
      }
    });
  </script>
</body>
</html>
